<html>
<head>
<title>Finding Duplicate Data Survey</title>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>

<style>
table, tr, td {
border: 1px solid #DBDBDB;
font-family: 'Montserrat', Trebuchet MS,Tahoma,Verdana,Arial,sans-serif;
font-size: 11px;
background-color: white;
padding: 2px;
}
table {
border-collapse: collapse;
margin: 5px;
}
body {
font-family: 'Montserrat', Trebuchet MS,Tahoma,Verdana,Arial,sans-serif;
  background-color: #EDEDED;
}
.ui-button, .ui-corner-all, .ui-widget {
font-family: 'Montserrat', Trebuchet MS,Tahoma,Verdana,Arial,sans-serif;
}
#current_question_content{
background-color: #E8E8E8;
margin: 15px;
padding:15px;
border: 1px solid #DBDBDB;
}
#explanation{
background-color: #E8E8E8;
margin: 15px;
padding:15px;
border: 1px solid #D19494;
font-size: 12px;
color: #454545;
}
.directions{
font-size: 12px;
margin: 3px;
}
.table_title{
	font-size: 15px;
}
.small{
	font-size: 12px;
}

button{
margin-top: 5px;
}
</style>

<script>
$(function(){ 

	function appendNextButton(div){
		var button = $("<button>Next</button>");
		button.button();
		button.click(nextHandler);
		div.append(button);
	}
	function appendPrevButton(div){
		var button = $("<button>Prev</button>");
		button.button();
		button.click(prevHandler);
		div.append(button);
	}
	function appendSubmitButton(div){
		var button = $("<button>Submit</button>");
		button.button();
		button.click(submitHandler);
		div.append(button);
	}

	function shuffle(a) {
		var j, x, i;
		for (i = a.length; i; i--) {
			j = Math.floor(Math.random() * i);
			x = a[i - 1];
			a[i - 1] = a[j];
			a[j] = x;
		}
	}

	var lastActionTime = (new Date()).getTime();
	var lastClicked = false;
	var times = [];
	var clickedLink = [];
var currentRandomizableIndex = -1; // -1 corresponds to the programmer question
var isProgrammer = false;

var randomizeable_question_divs = $(".randomizeable");
shuffle(randomizeable_question_divs);

var jqueryDivs = [];
for (var i = 0; i < randomizeable_question_divs.length; i++){
	times.push(0);
	clickedLink.push(false);

	var question = $(randomizeable_question_divs[i]);
	if (question.data("url")){
		var url = question.data("url");
		var link = $("<a href=\""+ url +"\" target=\"_blank\">"+url+"</a>");
		var urlDiv = $("<div class='small'>You can explore the data source here if you want to see more items: </div>");
		urlDiv.append(link);
		question.append(urlDiv);
	}

		    // now make the directions
		    var directions_text = $("#directions").html();
		    directions_text = directions_text.replace("{entity}", question.data("entity")).replace("{entity}", question.data("entity")).replace("{shortentity}", question.data("short-entity"));
		    question.find(".directions").html(directions_text);


		    jqueryDivs.push(question);
		}

		function cellsFromJqueryDiv(jqueryDiv){
			var rows = jqueryDiv.find("tr");
			var cells = _.map(rows, function(row){return $(row).find("td");});
			return cells;
		}

		function nextHandler(){
			questionChangeHandler();
			loadNewQuestion(currentRandomizableIndex + 1);
		}
		function prevHandler(){
			questionChangeHandler();
			loadNewQuestion(currentRandomizableIndex - 1);
		}
		function submitHandler(){
			questionChangeHandler();
		    // do the submit stuff
		    console.log("submit");
		    var msg = {};
		    var entities = [];
		    for (var i = 0; i < jqueryDivs.length; i++){
		    	var selectedCols = [];
		    	var cells = cellsFromJqueryDiv(jqueryDivs[i]);
		    	for (var j = 0; j < cells[0].length; j++){
		    		var checkbox = $(cells[0][j]).find("input");
		    		if (checkbox.attr('checked')){
		    			selectedCols.push($(cells[1][j]).html());
		    		}
		    	}
		    	var entity = {index: i, time: times[i], clickedLink: clickedLink[i], name: jqueryDivs[i].data("name"), selected: selectedCols};
		    	entities.push(entity);
		    }
		    msg.entities = entities;
		    msg.programmer = isProgrammer;
		    console.log("msg", msg);
		    $.ajax({
		    	type: "POST",
		    	url: "surveyresponse",
		    	contentType:"application/json; charset=utf-8",
		    	data: JSON.stringify(msg),
		    	success: function(){
		    		$("#current_question_content").html("All done!  Thank you so much for your help!");
		    	}
		    });
		    
		}

		function loadNewQuestion(index){

			currentRandomizableIndex = index;
			var question_div = $("#current_question");
			var navigation_div = $("#navigation");

			if (index === -1){
				navigation_div.html("");
				appendNextButton(navigation_div);
				question_div.html("Consent stuff.");
			}
			if (index === -2){
		    // put the question about programmer, not programmer back in
		    navigation_div.html("");
		    appendNextButton(navigation_div);
		    question_div.html($("#programmer_question").html());
		    $("#explanation").css("display", "none");

		    if (isProgrammer){
		    	question_div.find("#programmer_i").attr("checked", true);
		    }
		    else{
		    	question_div.find("#nonprogrammer_i").attr("checked", true);
		    }

		    question_div.find("#nonprogrammer").click(function(){
		    	isProgrammer = false;
		    	question_div.find("#programmer_i").attr("checked", false);
		    	question_div.find("#nonprogrammer_i").attr("checked", true);
		    	console.log(isProgrammer);
		    });
		    question_div.find("#programmer").click(function(){
		    	isProgrammer = true;
		    	question_div.find("#nonprogrammer_i").attr("checked", false);
		    	question_div.find("#programmer_i").attr("checked", true);
		    	console.log(isProgrammer);
		    });
		    return;
		}
		if (index === -3){
			navigation_div.html("");
			appendNextButton(navigation_div);
			question_div.html($("#tutorial").html());
		}

		if (index >= jqueryDivs.length){
			navigation_div.html("");
			appendPrevButton(navigation_div);
			appendSubmitButton(navigation_div);
			question_div.html("Ready to submit?");
			$("#explanation").css("display", "none");
			return;
		}

		// otherwise we're in one of the table questions, so handle that

		
		question_div.html(jqueryDivs[currentRandomizableIndex]);
		var link = question_div.find("a");
		link.click(function(){console.log("clicked link"); lastClicked = true;});
		$("#explanation").css("display", "block");

		var cells = cellsFromJqueryDiv(question_div);
		for (var i = 0; i < cells[0].length; i++){
			for (var j = 0; j < cells.length; j++){
				var cell = $(cells[j][i]);
				(function(){
					var ic = i;
					var jc = j;
					cell.click(function(){
						var checkbox = $(cells[0][ic]).find("input");
						if (checkbox.attr('checked')){
							checkbox.attr('checked', false);
							for (var k = 0; k < cells.length; k++){
								$(cells[k][ic]).css("background-color","white");
							}
						}
						else{
							checkbox.attr('checked', true);
							for (var k = 0; k < cells.length; k++){
								$(cells[k][ic]).css("background-color","#CFEFCF");
							}
						}
					});
				})();

			}
		}

		navigation_div.html("");
		if (index >= 0){
			appendPrevButton(navigation_div);
		}
		if (index < jqueryDivs.length){
			appendNextButton(navigation_div);
		}
	}

	function questionChangeHandler(){
		var newTime = (new Date()).getTime();
		var passedTime = newTime - lastActionTime;
		lastActionTime = newTime;

		var lastUrlClicked = lastClicked;
		lastClicked = false;

		if (currentRandomizableIndex >= 0 && currentRandomizableIndex < randomizeable_question_divs.length){
			times[currentRandomizableIndex] += passedTime;
			clickedLink[currentRandomizableIndex] = clickedLink[currentRandomizableIndex] || lastUrlClicked;
			console.log(currentRandomizableIndex, times[currentRandomizableIndex], clickedLink[currentRandomizableIndex]);
		}
	}

	loadNewQuestion(currentRandomizableIndex);

});

</script>

</head>
<body>
<h3>
Finding Duplicate Data Survey
</h3>

<div id="current_question_content">
  <div id="current_question">
    </div>

  <div id="navigation"></div>
  </div>

  <div id="explanation-1", class="explanation">
	<div class="table_title">Example</div>

	<div class="example_title">The situation:</div>
	You have a table of friends' names, ages, birthdays, and phone numbers.  Unfortunately, many friends appear in the table multiple times because the information has been collected several times.  You want a table that only lists each friend once, so you need to combine all the rows that refer to the same friend.  The goal is to collapse all the rows that refer to a single friend without collapsing rows that refer to different friends.
	<br>
	You're going to be picking a set of columns from the table.  If two rows have the same values in all of your selected columns, we'll merge the rows.  If they don't, we'll assume they refer to two different people.  You'll need to use your knowledge of what attributes tend to be unique about your friends.  You'll also need to use your knowledge of what attributes tend to stay the same over time.

	<div class="example_title">The data:</div>
	In this snippet of the table, the first two rows are from the same Alice at different points in time.  Her birthday and phone number are the same, but she was 37 for one of the rows and 38 for another.  The third and fourth rows refer to two different friends, both named Bob.
	<table>
	  <tr><td>name</td><td>age</td><td>birthday</td><td>phone_number</td></tr>
	  <tr><td>Alice</td><td>37</td><td>Feb 2, 1979</td><td>555-555-5555</td></tr>
	  <tr><td>Alice</td><td>38</td><td>Feb 2, 1979</td><td>555-555-5555</td></tr>
	  <tr><td>Bob</td><td>37</td><td>Jan 1, 1979</td><td>777-777-7777</td></tr>
	  <tr><td>Bob</td><td>38</td><td>May 20, 1979</td><td>999-999-9999</td></tr>
	</table>

	<div class="example_title">Some bad solutions:</div>
	<span class="selection">NAME</span>:
	Just selecting <span class="selection">NAME</span> doesn't work because although we successfully collapse the two Alice rows that refer to a single friend, we also collapse the two Bobs, even though they're different friends.
	<br>
	The bad outcome: we got rid of a Bob!
	<span class="selection">NAME AND AGE</span>:
	Selecting <span class="selection">NAME AND AGE</span> doesn't work because even though we now distinguish between between the two Bobs, we also distinguish between the two Alice rows, even though they refer to the same friend.
	<br>
	The bad outcome: we kept a fake Alice!

	<div class="example_title">Some good solutions:</div>
		
	<span class="selection">PHONE_NUMBER</span>:
	<img src="ex1.png" height=80px>
	You know none of your friends share a phone number, so if you see a second row with a particular phone number, you know it refers to the same friend as the first row with that phone number.  You merge the Alice rows and keep both Bobs!
	<br>

	<span class="selection">NAME AND BIRTHDAY</span>:
	<img src="ex2.png" height=80px>
	Alternatively, you know the Bobs have the same name, but not the same birthday, so you select the checkboxes for name and birthday.  Even though Alice is in the table multiple times, her birthday won't change, so you merge the Alice rows and keep both Bobs!
  </div>


  <div id="explanation-2", class="explanation">
  	For the rest of this survey, you'll be completing this same task, but not for friends -- instead you'll be completing the task for eight different entities.  You'll only see the first row of the table, so you'll need to think about what attributes are unique about the rows and what attributes will stay the same over time.
  </div>


<div id="hidden" style="display:none">

<div id="programmer_question">
  <div>
    Are you a programmer?
    </div>
  <table>
    <tr id="nonprogrammer"><td><input id="nonprogrammer_i" type="radio" name="programmer" value="nonprogrammer"> No, I'm not a programmer.</td></tr>
    <tr id="programmer"><td><input id="programmer_i" type="radio" name="programmer" value="programmer"> Yes, I'm a programmer.</td></tr>
    </table>
</div>

<div class="randomizeable" data-name="twitterfoundations" data-entity="foundation" data-short-entity="foundation">
<div class="table_title">Charitable Foundations</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr><tr><td>foundation_rank</td><td>name</td><td>name_alternate</td><td>url</td><td>url_2</td></tr><tr><td>1</td><td>Bill &amp; Melinda Gates Foundation</td><td>Gates Foundation, Bill &amp; Melinda</td><td>https://twitter.com/gatesfoundation/with_replies</td><td>https://twitter.com/gatesfoundation/</td></tr></tbody></table>
</div>

<div class="randomizeable" data-name="zimride" data-entity="carpool ride listing" data-short-entity="listing">
<div class="table_title">Zimride Carpool Listings (for offering or requesting rides)</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr><tr><td>carpool_endpoints</td><td>user_name</td><td>carpool_times</td><td>driver_or_passenger</td><td>carpool_days</td></tr><tr><td>Bothell<br>To and From<br>Seattle</td><td>Sam V</td><td>Commute MTWTF 6:00am / 4:15pm ±30m</td><td>passenger</td><td>Sam takes this trip every<br>                                                                                                            Mon,                                                                                                                                                Tue,                                                                                                                                                Wed,                                                                                                                                                Thu,                                                                                                                                                Fri</td></tr></tbody></table>
</div>

<div class="randomizeable" data-name="communityfoundations"  data-entity="foundation" data-short-entity="foundation">
<div class="table_title">Community Foundations</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td></tr><tr><td>foundation_id</td><td>foundation_url</td></tr><tr><td>2</td><td>http://communityfoundationatlas.org/explore/#foundation=2</td></tr></tbody></table>
</div>

<div class="randomizeable" data-name="restaurants"  data-entity="restaurant" data-short-entity="restaurant" data-url="https://www.yelp.com/search?find_desc=Restaurants&find_loc=Seattle%2C+WA&ns=1">
<div class="table_title">Restaurants</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr>
<tr><td>restaurant_name</td><td>restaurant_link</td><td>phone_number</td><td>featured_quote</td><td>address</td><td>neighborhood</td><td>price_range</td><td>genres</td><td>num_reviews</td><td>average_rating</td></tr>
<tr><td>Paseo Caribbean Food - Fremont</td><td>https://www.yelp.com/biz/paseo-caribbean-food-fremont-seattle-2?osq=Restaurants</td><td>(206) 545-7440</td><td>It is that good, even for vegetarians. &nbsp;The tofu is perfectly seasoned over a bed of rice with a rich tomato sauce and refreshing salad. The side of black beans is more of a soupy…<br>read more</td><td>4225 Fremont Ave N<br>Seattle, WA 98103</td><td>Fremont</td><td>$</td><td>Caribbean<br>,<br>Cuban<br>,<br>Sandwiches</td><td>4325 reviews</td><td>4.5 star rating</td></tr></tbody></table>
</div>


<div class="randomizeable" data-name="tweets" data-entity="tweet" data-short-entity="tweet" data-url="https://twitter.com/gatesfoundation?lang=en">

<div class="table_title">Tweets</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td>
</tr><tr><td>name</td><td>username</td><td>text</td><td>date_posted</td><td>link</td><td>num_hearts</td><td>num_retweets</td></tr>
<tr><td>Gates Foundation</td><td>gatesfoundation</td><td>It's #IWD2017 and 225 million women in the developing world still don't have access to contraceptives. Four families share why it's so vital pic.twitter.com/P7eS5EjXxh</td><td>3 h</td><td>https://twitter.com/gatesfoundation/status/839462156013690881</td><td>199</td><td>163</td></tr></tbody></table>
</div>

<div class="randomizeable" data-name="reviews" data-entity="restuarant review" data-short-entity="review" data-url="https://www.yelp.com/biz/paseo-caribbean-food-fremont-seattle-2?osq=Restaurants">
<div class="table_title">Restaurant Review</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr><tr><td>date</td><td>rating</td><td>text</td><td>reviewer_city</td><td>reviewer</td></tr>
<tr><td>3/11/2017</td><td>5.0 star rating</td><td>It is that good, even for vegetarians.<br>The tofu is perfectly seasoned over a bed of rice with a rich tomato sauce and refreshing salad. The side of black beans is more of a soupy mixture that tastes delicious when drizzled over the rest of the food. Even the corn on the cob was worth eating.<br>Rightly so, the place filled in quickly so plan on getting there during a non-busy hour or taking this to go. Whatever you do, just make sure you get there.</td><td>Seattle, WA</td><td>Katy H.</td></tr></tbody></table>
</div>

<div class="randomizeable" data-name="menuitems" data-entity="menu item" data-short-entity="item" data-url="https://www.yelp.com/menu/paseo-caribbean-food-fremont-seattle-2">
<div class="table_title">Menu Items</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr><tr><td>name</td><td>price</td><td>photos</td><td>photos_link</td><td>reviews</td><td>reviews_link</td><td>description</td></tr>
<tr><td>Grilled Pork</td><td>$8.50</td><td>18 photos</td><td>https://www.yelp.com/menu/paseo-caribbean-food-fremont-seattle-2/item/grilled-pork</td><td>130 reviews</td><td>https://www.yelp.com/menu/paseo-caribbean-food-fremont-seattle-2/item/grilled-pork#menu-reviews</td><td>cubed pork loin grilled over lava rocks &amp; basted w/ paseo marinade until golden brown.</td></tr></tbody></table>
</div>

<div class="randomizeable" data-name="craigslist" data-entity="craigslist apartment listing" data-short-entity="listing" data-url="https://seattle.craigslist.org/search/apa">
<div class="table_title">Craigslist Listings</div>
<div class="directions"></div>
<table><tbody><tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr>
<tr><td>listing_title</td><td>price</td><td>date_posted</td><td>location</td><td>features</td><td>link</td></tr>
<tr><td>Studio w/ Den and Patio! Available March 4th!</td><td>$1465</td><td>Feb 21</td><td>(Downtown Bellevue)</td><td>1br -<br>                    580ft<br>2<br>-</td><td>https://seattle.craigslist.org/est/apa/6014028599.html</td></tr></tbody></table>
</div>

------

Example Table
<table>
  <tr><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td><td><input type="checkbox"></td></tr>
  <tr><td>name text</td><td>age text</td><td>birthday text</td><td>phone_number text</td></tr>
  <tr><td>Alice</td><td>38</td><td>Feb 2, 1979</td><td>555-555-5555</td></tr>
</table>

<div id="directions">
Each row represents a <span class="entity">{entity}</span>.  Some {shortentity}s appear more than once.  Pick columns that identify unique  <span class="entity">{entity}s</span>.
</div>

</div>
</body>
</html>
